<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Noise Monitor (HTTP Polling)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body style="text-align:center; font-family:sans-serif;">
    <h2>üìà Real-Time Noise Level</h2>
    <canvas id="noiseChart" width="600" height="300"></canvas>
    <p id="alert"></p>

    <script>
        const ctx = document.getElementById('noiseChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Noise Level (dB)',
                    data: [],
                    borderWidth: 2,
                    borderColor: 'blue'
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } }
            }
        });

        const alertBox = document.getElementById('alert');

        // --- HTTP polling ---
        async function updateChart() {
            const res = await fetch('/data');
            const data = await res.json();
            const latest = parseFloat(data.value);
            const now = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' });

            chart.data.labels.push(now);
            chart.data.datasets[0].data.push(latest);

            // keep only last 20 data points
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();

            if (latest > 68) {
                alertBox.textContent = "‚ö†Ô∏è Environment too loud!";
                alertBox.style.color = "red";
                document.body.style.background = "#ffe5e5";
            } else {
                alertBox.textContent = "‚úÖ Safe noise level";
                alertBox.style.color = "green";
                document.body.style.background = "white";
            }
        }

        setInterval(updateChart, 2000);
        updateChart();

    </script>
</body>

</html>